[TOC]

# Redis缓存

## 1、Redis数据类型

### 1.1、基本数据类型

Redis有5中基础数据类型

* 1、字符串 `String`

  Redis中的字符串是二进制安全的，可以存储任何类型的数据，包括图片、序列化对象

  ```bash
  set name kangyong
  get name
  ```

* 2、哈希`Hashes`

  Redis哈希是一个键值对集合，适合存储对象，可以添加、获取、删除哈希中的元素

   ```bash
  hset homepage redis redis.com

  hget homepage redis
   ```

* 3、列表`List`

  Redis列表是一个有序的字符串列表，可以添加、获取、删除列表的元素，支持从列表的两端推入和弹出元素

* 4、集合`Sets`

  Redis集合是一个无序的字符串列表，可以添加、获取、删除集合中的元素

* 5、有序集合`Sorted Set`

  Redis有序集合是一个有序的字符串列表，每个元素都有一个分数，可以根据分数排序，支持添加、获取、删除有序集合中的元素

### 1.2、扩展数据类型

* 1、`HyperLogLog`
* 2、`Geo`
* 3、`Pub\Sub`
* 4、`Redis Module`
* 5、`BloomFilter`布隆过滤器
* 6、`RedisSearch`
* 7、`Redis-ML`

## 2、* Redis哪些操作是原子性的

Redis保证每个操作的执行是不可分割的，要么执行成功，要么不执行。因此，在高并发的场景下，这些操作是非常有用的。

Redis提供了一部分原子性的操作，如下：

* 1、`SET key value`：设置键值对，如果键已经存在，则覆盖原有值
* 2、`INCR key`：将键对应的值加1，如果键不存在，则将其初始化为0
* 3、`DECR key`：将键对应的值减1，如果键不存在，则将其初始化为0
* 4、`LPUSH key value`：将值插入到列表的左端，如果列表不存在，则创建一个空列表
* 5、`RPUSH key value`：将值插入到列表的右端，如果列表不存在，则创建一个空列表
* 6、`SADD key member`：将成员添加到集合中，如果集合不存在，则创建一个空集合
* 7、`HSET key field value`：将哈希表中给定字段的值设置为指定值，如果哈希表不存在，则创建一个空哈希表

不是所有Redis操作都是原子性的。虽然Redis是一个高性能、高可用的内存数据库，但是在实际使用中，一些操作可能并不是原子性的，这需要根据具体的操作来判断。

例如：对于一个列表，如果多个客户端同事对其进行操作，比如在列表的左端或右端插入元素，可能会导致并发问题，因为在某个客户端执行LPUSH或RPUSH操作时，另一个客户端也可能在同时执行相同的操作，这可能导致列表的元素顺序不确定，或者发生重复插入的情况。

## 3、Redis排序

Redis支持多种排序操作，包括：

* 1、SORT命令：可以对存储在列表、集合、有序集合的元素进行排序，支持对字符串、数字等类型的数据进行排序，还支持降序、升序等多种排序分方式。
* 2、ZRAND命令：对有序集合中的元素进行排序，支持按照元素分值进行排序，也支持按照元素在几何中的位置进行排序。
* 3、ZREVRANGE命令：对有序集合中的元素进行反向排序，支持按照元素分值进行排序，也支持按照元素在集合中的位置进行排序。

以下是一个使用SORT命令进行排序的示例：

```bash
# 假设有一个列表名为mylist，包含5个元素，如下：
1）“10”
2）“5”
3）“20”
4）“3”
5）“15”

# 对该列表进行升序排序
SORT mylist

# 对该列表进行降序排序
SORT mylist DESC
```



## 4、Redis怎么做消息队列

## 5、Redis持久化

Redis提供了两种持久化方式：RDB（Redis Database Backup）和AOF（Append Only File）。

RDB是一种快照方式的持久化方式，可以将Redis在某一时刻的数据生成一个快照文件，保存到硬盘上。通过这种方式，我们可以在需要的时候快速地恢复Redis的数据。RDB是通过fork子进程的方式生成快照文件的，所以在持久化过程中可能会对Redis产生一定的性能影响。可以通过设置fork时机的方式来减少对性能的影响。

AOF是一种追加方式的持久化方式，可以将Redis知性的每一条写命令追加到AOF文件中，保证了数据的实时同步。在Redis重启时，可以通过重新执行AOF文件中的写命令来恢复数据。AOF方式相比RDB方式可以更加精确的恢复数据，但是也会占用更多的磁盘空间，同事在写入大量数据的情况下会产生一定得性能影响。

可以通过在Redis配置文件中设置`save` 和`appendonly` 参数来开启RDB和AOF持久化。例如，以下配置表示当900秒内有1个key发生变化时，自动执行一次RDB持久化，当每秒钟至少有一个写操作时，将写命令追加到AOF文件中。

```bash
save 900 1
appendonly yes
```



## 6、Redis缓存雪崩、缓存穿透、缓存击穿

### 6.1、缓存雪崩

如果有大量的key过期时间设置的过于集中，到过期的那个时间点，Redis可能会出现短暂的卡顿现象。严重的话会出现缓存雪崩，我们一般需要在时间上加一个随机值，使得过期时间分散一些。

解决方法：

* 1、加缓存失效时间加个随机数，使得过期时间分散一些

### 6.2、缓存穿透

缓存穿透是指缓存和数据库中都没有的数据，而用户不断发起请求。

解决方法：

* 1、对id进行校验
* 2、接口请求校验
* 3、限流
* 4、如果查询到为null，也缓存几秒，具体场景跟产品确认
* 5、布隆过滤器`Bloom Filter`

### 6.3、缓存击穿

缓存击穿是指一个key非常热点，在不停的扛着大并发，大并发集中对这个点进行访问，当这个key在失效的瞬间，持续的大并发就穿破缓存，直接请求数据库，就像在一个完好无损的桶上凿开了一个洞。

解决方法：

* 1、设置数据永不过期
* 2、加互斥锁（就是给查库的代码加上锁）

## 7、Redis 高可用

### 7.1、Redis高可用方案

Redis高可用方案主要包括主从复制、哨兵模式和集群模式三种：

* 1、主从复制：

  在主从复制模式下，Redis会将一个节点的所有写操作发送给主节点，然后主节点会同步数据到从节点，从节点只负责读操作。当主节点故障时，从节点中选举一个作为新的主节点继续提供服务。

* 2、哨兵模式：

  在哨兵模式下，Redis会有一些特殊的Redis节点作为哨兵节点，这些节点会监控所有Redis实例的运行状况。当主节点故障是，哨兵会从所有从节点中选取一个新的主节点，并将客户端重新定向到新的主节点上。

* 3、集群模式：

  在Redis集群模式下，多个节点组成一个集群，每个节点都保存了部分数据。当客户端连接到集群时，Redis会根据分片算法将数据分配到各个节点上。当某个节点故障时，集群会将该节点上的数据迁移到其他节点上，保证数据的高可用。

综合考虑：哨兵模式适合中小规模的Redis应用，主从复制适合对可靠性要求不高的情况，而集群规模则适合大规模Redis应用，能够提供更高的功能和可靠性。